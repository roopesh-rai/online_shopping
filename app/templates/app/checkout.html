{% extends 'app/basic.html' %}
{% block title %}Checkout{% endblock %}
{% block css %}
div{
    text-align: justify;
    text-justify: inter-word;
}
section {
  background: #ffffff;
  display: flex;
  flex-direction: column;
  width: 400px;
  height: 112px;
  border-radius: 6px;
<!--  border-color: #ffffff;-->
  justify-content: space-between;
}
.product {
  display: flex;
  text-align: center;
}
.description {
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align:center;
  margin: auto;
  width: 50%;
  border: 3px solid green;
  padding: 10px;
}
img {
  border-radius: 6px;
  margin: 10px;
  width: 54px;
  height: 57px;
}
h3,
h5 {
  font-style: normal;
  font-family: times new roman;
  font-weight: 500;
  font-size: 18px;
  line-height: 20px;
  letter-spacing: -0.154px;
  color: #242d60;
  margin: 0;
}
h5 {
  opacity: 0.5;
}
button {
  height: 36px;
  background: #556cd6;
  color: white;
  width: 100%;
  font-size: 14px;
  border: 0;
  font-weight: 500;
  cursor: pointer;
  letter-spacing: 0.6;
  border-radius: 0 0 6px 6px;
  transition: all 0.2s ease;
  box-shadow: 0px 4px 5.5px 0px rgba(0, 0, 0, 0.07);
}
button:hover {
  opacity: 0.8;
}




/* Variables */
* {
  box-sizing: border-box;
}

<!--body {-->
<!--  font-family: -apple-system, BlinkMacSystemFont, sans-serif;-->
<!--  font-size: 16px;-->
<!--  -webkit-font-smoothing: antialiased;-->
<!--  display: flex;-->
<!--  justify-content: center;-->
<!--  align-content: center;-->
<!--  height: 100vh;-->
<!--  width: 100vw;-->
<!--}-->

form {
  width: 30vw;
  min-width: 500px;
  align-self: center;
  box-shadow: 0px 0px 0px 0.5px rgba(50, 50, 93, 0.1),
    0px 2px 5px 0px rgba(50, 50, 93, 0.1), 0px 1px 1.5px 0px rgba(0, 0, 0, 0.07);
  border-radius: 7px;
  padding: 40px;
}

.hidden {
  display: none;
}

#payment-message {
  color: rgb(105, 115, 134);
  font-size: 16px;
  line-height: 20px;
  padding-top: 12px;
  text-align: center;
}

#payment-element {
  margin-bottom: 24px;
}

/* Buttons and links */
button {
  background: #5469d4;
  font-family: Arial, sans-serif;
  color: #ffffff;
  border-radius: 4px;
  border: 0;
  padding: 12px 16px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: block;
  transition: all 0.2s ease;
  box-shadow: 0px 4px 5.5px 0px rgba(0, 0, 0, 0.07);
  width: 100%;
}
button:hover {
  filter: contrast(115%);
}
button:disabled {
  opacity: 0.5;
  cursor: default;
}

/* spinner/processing state, errors */
.spinner,
.spinner:before,
.spinner:after {
  border-radius: 50%;
}
.spinner {
  color: #ffffff;
  font-size: 22px;
  text-indent: -99999px;
  margin: 0px auto;
  position: relative;
  width: 20px;
  height: 20px;
  box-shadow: inset 0 0 0 2px;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
}
.spinner:before,
.spinner:after {
  position: absolute;
  content: "";
}
.spinner:before {
  width: 10.4px;
  height: 20.4px;
  background: #5469d4;
  border-radius: 20.4px 0 0 20.4px;
  top: -0.2px;
  left: -0.2px;
  -webkit-transform-origin: 10.4px 10.2px;
  transform-origin: 10.4px 10.2px;
  -webkit-animation: loading 2s infinite ease 1.5s;
  animation: loading 2s infinite ease 1.5s;
}
.spinner:after {
  width: 10.4px;
  height: 10.2px;
  background: #5469d4;
  border-radius: 0 10.2px 10.2px 0;
  top: -0.1px;
  left: 10.2px;
  -webkit-transform-origin: 0px 10.2px;
  transform-origin: 0px 10.2px;
  -webkit-animation: loading 2s infinite ease;
  animation: loading 2s infinite ease;
}

@-webkit-keyframes loading {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes loading {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}

@media only screen and (max-width: 600px) {
  form {
    width: 80vw;
    min-width: initial;
  }
}


<script>
const items = [{ id: "xl-tshirt" }];

let elements;

initialize();
checkStatus();

document
  .querySelector("#payment-form")
  .addEventListener("submit", handleSubmit);

// Fetches a payment intent and captures the client secret
async function initialize() {
  const response = await fetch("/create-payment-intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items }),
  });
  const { clientSecret } = await response.json();

  const appearance = {
    theme: 'stripe',
  };
  elements = stripe.elements({ appearance, clientSecret });

  const paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");
}

async function handleSubmit(e) {
  e.preventDefault();
  setLoading(true);

  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: {
      // Make sure to change this to your payment completion page
      return_url: "http://localhost:8000/success.html",
    },
  });

  // This point will only be reached if there is an immediate error when
  // confirming the payment. Otherwise, your customer will be redirected to
  // your `return_url`. For some payment methods like iDEAL, your customer will
  // be redirected to an intermediate site first to authorize the payment, then
  // redirected to the `return_url`.
  if (error.type === "card_error" || error.type === "validation_error") {
    showMessage(error.message);
  } else {
    showMessage("An unexpected error occured.");
  }

  setLoading(false);
}

// Fetches the payment intent status after payment submission
async function checkStatus() {
  const clientSecret = new URLSearchParams(window.location.search).get(
    "payment_intent_client_secret"
  );

  if (!clientSecret) {
    return;
  }

  const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

  switch (paymentIntent.status) {
    case "succeeded":
      showMessage("Payment succeeded!");
      break;
    case "processing":
      showMessage("Your payment is processing.");
      break;
    case "requires_payment_method":
      showMessage("Your payment was not successful, please try again.");
      break;
    default:
      showMessage("Something went wrong.");
      break;
  }
}

// ------- UI helpers -------

function showMessage(messageText) {
  const messageContainer = document.querySelector("#payment-message");

  messageContainer.classList.remove("hidden");
  messageContainer.textContent = messageText;

  setTimeout(function () {
    messageContainer.classList.add("hidden");
    messageText.textContent = "";
  }, 4000);
}

// Show a spinner on payment submission
function setLoading(isLoading) {
  if (isLoading) {
    // Disable the button and show a spinner
    document.querySelector("#submit").disabled = true;
    document.querySelector("#spinner").classList.remove("hidden");
    document.querySelector("#button-text").classList.add("hidden");
  } else {
    document.querySelector("#submit").disabled = false;
    document.querySelector("#spinner").classList.add("hidden");
    document.querySelector("#button-text").classList.remove("hidden");
  }
}</script>
<script src="https://js.stripe.com/v3/"></script>

{% endblock %}
{% block body %}

<div class="container" xmlns="http://www.w3.org/1999/html">
 <div class="row mt-5">
  <div class="col-sm-6">
    <h4>Order Summary</h4>
    <hr>
     {% for item in cart_items%}
        <div class="card mb-2">
          <div class="card-body">
              <h5>Product: {{item.product.title}}</h5>
              <p>Quantity: {{item.quantity}}</p>
              <p class="fw-bold">Price: {{item.total_cost}}</p>
          </div>
        </div>
     {% endfor %}
      {% for item in prod_items %}
          <div class="card mb-2">
            <div class="card-body">
              <h5>Product: {{item.title}}</h5>
              <p>Quantity: {{forloop.counter}}</p>
              <p class="fw-bold">Price: {{item.discounted_price}}</p>
            </div>
          </div>
      {% endfor %}
      <b><p class="fw-bold">Total Cost + Shipping Amount = {{totalamount}}</p></b>
<small>
    The website  is operated by Plutus Technologies Private Limited ("Plutus" or "us" or "we" or "our"), having its registered office located 4th Floor, Akshar Stadia, behind Gurudwara, Bodakdev, Ahmedabad, Gujarat-380054 , India. Please read the Conditions of Use document carefully before using the website. By using the  website, you signify your agreement to be bound by website's Conditions of Use. Details can be found here. As described in our Privacy Notice, we share information with website, Inc. and the subsidiaries that plutus, Inc. controls that are either subject to our Privacy Notice or follow practices at least as protective as those described in our Privacy Notice. We also share information with third-party service providers. For example, we use third-party service providers to fulfil orders for products or services, and to deliver packages. For any further details on our security practices please read our Privacy Notice. For any queries or issues relating to Websiter</small>
  </div>
  <div class="col-sm-4 offset-sm-1">
    <h4>Select Shipping Address</h4>
    <hr>
    <form action="/paymentdone" id="myform">
      {% for ad in add%}
      <div class="card">
        <div class="card-body">
        <h5>{{ad.name}}</h5>
        <p>{{ad.locality}}, {{ad.city}}, {{ad.state}} - {{ad.zipcode}}</p>
          </div>
      </div>
        <div class="form-check mt-2 mb-5">
          <input class="form-check-input" type="radio" value="{{ad.id}}" name="custid" id="custadd{{forloop.counter}}">
          <label class="form-check-label fw-bold" >
            Address: {{forloop.counter}} </label>
        </div>
        {% endfor %}
        <div class="text-end">
          {% if Exception %}
<!--          <label class="form-check-label fw-bold"> Address: {{address}} </label>-->
          {% endif %}
<!--          <button type="submit" class="btn btn-warning mt-3 px-5 fw-bold">Continue</button>-->
          <section>
          <div class="product">
<!--              <img src="" alt="" />-->
              <div class="description" border-color="#ffffff">
                    <h3> RS. {{totalamount}}</h3>
              </div>
          </div>
          <form action="/create-checkout-session" method="POST">
              <button type="submit" id="checkout-button">Checkout</button>
          </form>
          </section>
            <section>
            <form id="payment-form">
              <div id="payment-element">
                <!--Stripe.js injects the Payment Element-->
              </div>
              <button id="submit" type="submit">
                  <div class="spinner hidden" id="spinner"></div>
                  <span id="button-text">Pay now</span>
              </button>
              <div id="payment-message" class="hidden"></div>
            </form>
            </section>
<!--                Set up a container element for the button -->
<!--              <div id="paypal-button-container"></div>-->
<!--            <button type="submit" class="btn btn-warning mt-3 px-5 fw-bold">Continue</button>-->
<!--          <script src="https://checkout.stripe.com/checkout.js" class="stripe-button btn-warning mt-3 px-5 fw-bold">-->
<!--              data-key="{{ key }}"-->
<!--              data-description = "Payment Gateway"-->
<!--              data-amount = {{product.price}}-->
<!--              data-locate = "auto"-->
<!--          </script>-->
        </div>
      </form>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
{% block js %}

{% endblock %}
{% block  payment-gateway %}
{% endblock %}
{% endblock %}